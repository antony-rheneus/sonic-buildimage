From 16a3ab02faa41bbba19e5e445472e42fa47cb6ee Mon Sep 17 00:00:00 2001
From: arheneus <arheneus@marvell.com>
Date: Thu, 31 Oct 2019 12:20:11 +0530
Subject: [PATCH] Adding port member failed during port init in "team_option
 *team_get_option()" which got err as -ENOENT (-2). If port init failed, it
 does rollback and remove the LAG member and never adds back until reboot TO
 avoid this, retry the port init 30 times.

Failure LOG from teamd.log:
Ethernet50: Failed to find "enabled" option.
get_ifinfo_list: check_call_change_handers failed
Failed to get interface information list.
Failed to refresh interface information list.
Ethernet50: Team refresh failed.

Signed-off-by: arheneus <arheneus@marvell.com>

diff --git a/teamd/teamd_per_port.c b/teamd/teamd_per_port.c
index b5b8c04..9658035 100644
--- a/teamd/teamd_per_port.c
+++ b/teamd/teamd_per_port.c
@@ -104,18 +104,27 @@ static int port_priv_init_all(struct teamd_context *ctx, struct port_obj *port_o
 	list_for_each_node_entry(ppitem, &port_obj->priv_list, list) {
 		if (!ppitem->pp->init)
 			continue;
+                /* Retry logic added during poirt init while adding lag member, as if fails it never adds back.
+                 * One of the failure seen during testing is team_get_option() return failure as it couldn't get port enabled option
+                 */
                 while(--retry)
                 {
-		err = ppitem->pp->init(ctx, _port(port_obj), &ppitem->priv,
-				       ppitem->creator_priv);
-		if (err) {
-			teamd_log_err("Failed to init port priv. err %d retries %d", err, (RETRY_BEFORE_ROLLING_BACK - retry));
+                    err = ppitem->pp->init(ctx, _port(port_obj), &ppitem->priv,
+                            ppitem->creator_priv);
+                    if (err) {
+                        teamd_log_err("Failed to init port priv. err %d retries %d", err, (RETRY_BEFORE_ROLLING_BACK - retry));
                         if (retry <= 0)
-			goto rollback;
-		}
-                else {
-                    break;
-                }
+                        {
+                            goto rollback;
+                        }
+                        else
+                        {
+                            sleep(1);
+                        }
+                    }
+                    else {
+                        break;
+                    }
                 }
 	}
 	return 0;
-- 
2.7.4

